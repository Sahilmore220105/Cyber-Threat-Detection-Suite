import streamlit as st
import joblib
import os
from src.extract import get_pe_features

st.title("üõ°Ô∏è PE Malware Classifier")
uploaded_file = st.file_uploader("Upload a Windows Executable (.exe)", type="exe")

if uploaded_file and st.button("Scan File"):
    # Save temp file to scan
    with open("temp_file.exe", "wb") as f:
        f.write(uploaded_file.getbuffer())

    features = get_pe_features("temp_file.exe")
    
    if features is not None:
        model = joblib.load("models/malware_model.pkl")
        prediction = model.predict(features)[0]
        confidence = model.predict_proba(features)[0] # Get probability
        
        st.subheader("Analysis Results")
        if prediction == 1:
            st.error(f"üö® MALICIOUS (Confidence: {confidence[1]*100:.2f}%)")
            st.progress(confidence[1]) # Visual bar for threat level
        else:
            st.success(f"‚úÖ SAFE (Confidence: {confidence[0]*100:.2f}%)")
            st.progress(confidence[1]) # Show the low risk level
            
        # Show extracted features for transparency
        st.write("Extracted PE Header Features:")
        st.dataframe(features)
    else:
        st.error("Could not extract PE features from the file.")